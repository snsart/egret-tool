var __reflect=this&&this.__reflect||function(t,e,n){t.__class__=e,n?n.push(e):n=[e],t.__types__=t.__types__?n.concat(t.__types__):n},__extends=this&&this.__extends||function(t,e){function n(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);n.prototype=e.prototype,t.prototype=new n},__awaiter=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))(function(o,i){function a(t){try{c(r.next(t))}catch(e){i(e)}}function s(t){try{c(r["throw"](t))}catch(e){i(e)}}function c(t){t.done?o(t.value):new n(function(e){e(t.value)}).then(a,s)}c((r=r.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function n(t){return function(e){return r([t,e])}}function r(n){if(o)throw new TypeError("Generator is already executing.");for(;c;)try{if(o=1,i&&(a=i[2&n[0]?"return":n[0]?"throw":"next"])&&!(a=a.call(i,n[1])).done)return a;switch(i=0,a&&(n=[0,a.value]),n[0]){case 0:case 1:a=n;break;case 4:return c.label++,{value:n[1],done:!1};case 5:c.label++,i=n[1],n=[0];continue;case 7:n=c.ops.pop(),c.trys.pop();continue;default:if(a=c.trys,!(a=a.length>0&&a[a.length-1])&&(6===n[0]||2===n[0])){c=0;continue}if(3===n[0]&&(!a||n[1]>a[0]&&n[1]<a[3])){c.label=n[1];break}if(6===n[0]&&c.label<a[1]){c.label=a[1],a=n;break}if(a&&c.label<a[2]){c.label=a[2],c.ops.push(n);break}a[2]&&c.ops.pop(),c.trys.pop();continue}n=e.call(t,c)}catch(r){n=[6,r],i=0}finally{o=a=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var o,i,a,s,c={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return s={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s},Role=function(t){function e(){return t.call(this)||this}return __extends(e,t),Object.defineProperty(e.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t},enumerable:!0,configurable:!0}),e.GHOSR_TYPE="ghost",e.GIANT_TYPE="giant",e}(egret.Sprite);__reflect(Role.prototype,"Role");var DragDisplayObject=function(){function t(t,e,n,r){void 0===e&&(e=null),void 0===n&&(n=null),void 0===r&&(r=null),this.center=!0,this.range=null,this.handle=null,this.distance=50,this.angle=0,this.obj=t,this.mouseup=e,this.mousedown=n,this.mousemove=r}return t}();__reflect(DragDisplayObject.prototype,"DragDisplayObject");var Ghost=function(t){function e(){var e=t.call(this)||this;return e.type=Role.GHOSR_TYPE,e.draw(),e.live(),e}return __extends(e,t),e.prototype.die=function(){this._rolelive.visible=!1,this._roledeath.visible=!0},e.prototype.live=function(){this._rolelive.visible=!0,this._roledeath.visible=!1},e.prototype.draw=function(){this._rolelive=this.createBitmapByName("ghost_png");var t=this._rolelive;t.width=70,t.height=70,t.anchorOffsetX=t.width/2,t.anchorOffsetY=t.height/2,this.addChild(t),this._roledeath=this.createBitmapByName("death_png");var e=this._roledeath;e.width=70,e.height=70,e.anchorOffsetX=e.width/2,e.anchorOffsetY=e.height/2,this.addChild(e)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,n=RES.getRes(t);return e.texture=n,e},e}(Role);__reflect(Ghost.prototype,"Ghost");var Giant=function(t){function e(){var e=t.call(this)||this;return e.type=Role.GIANT_TYPE,e.draw(),e}return __extends(e,t),e.prototype.draw=function(){var t=this.createBitmapByName("giant_png");t.width=70,t.height=70,t.anchorOffsetX=t.width/2,t.anchorOffsetY=t.height/2,this.addChild(t)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,n=RES.getRes(t);return e.texture=n,e},e}(Role);__reflect(Giant.prototype,"Giant");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.onProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var Main=function(t){function e(){var e=t.call(this)||this;return e.mates=[],e.roles=[],e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.runGame()["catch"](function(t){console.log(t)})},e.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(n){switch(n.label){case 0:return[4,this.loadResource()];case 1:return n.sent(),this.createGameScene(),[4,RES.getResAsync("description_json")];case 2:return t=n.sent(),[4,platform.login()];case 3:return n.sent(),[4,platform.getUserInfo()];case 4:return e=n.sent(),console.log(e),[2]}})})},e.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var t,e;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),t=new LoadingUI,this.stage.addChild(t),[4,RES.loadConfig("resource/default.res.json","resource/")];case 1:return n.sent(),[4,RES.loadGroup("preload",0,t)];case 2:return n.sent(),this.stage.removeChild(t),[3,4];case 3:return e=n.sent(),console.error(e),[3,4];case 4:return[2]}})})},e.prototype.createGameScene=function(){var t=new egret.Shape;t.graphics.beginFill(0),t.graphics.drawRect(0,0,this.stage.stageWidth,this.stage.stageHeight),this.addChild(t),this.lineShape=new egret.Shape,this.lineShape.filters=[new egret.GlowFilter(255,.1,20,20,50)],this.addChild(this.lineShape),this.createRoles(10);var e=this.createBitmapByName("shootBtn_png");this.addChild(e),e.width=200,e.height=200,e.anchorOffsetX=e.width/2,e.anchorOffsetY=e.height/2,e.x=this.stage.stageWidth/2,e.y=this.stage.stageHeight-e.height/2,e.touchEnabled=!0,e.addEventListener(egret.TouchEvent.TOUCH_BEGIN,function(){this.startShoot()},this),this.stage.addEventListener(egret.TouchEvent.TOUCH_END,function(){this.stopShoot()},this)},e.prototype.createRoles=function(t){for(var e=0;t>e;e++){var n=new Ghost;n.x=Math.random()*this.stage.stageWidth,n.y=Math.random()*(this.stage.stageHeight-200),ObjectDecorator.get(n).addDragAction(this.stage),this.addChild(n);var r=new Giant;r.x=Math.random()*this.stage.stageWidth,r.y=Math.random()*(this.stage.stageHeight-200),ObjectDecorator.get(r).addDragAction(this.stage),this.addChild(r),this.roles.push(n,r)}},e.prototype.stopShoot=function(){var t=this.lineShape.graphics;t.clear();for(var e=0;e<this.roles.length;e++)this.roles[e].type==Role.GHOSR_TYPE&&this.roles[e].live()},e.prototype.startShoot=function(){var t=this.lineShape.graphics;t.clear(),t.lineStyle(1,9476607);for(var e=0;e<this.roles.length;e++)this.roles[e].type==Role.GHOSR_TYPE&&(console.log(this.roles[e]),this.roles[e].die());var n=this.mates=[];this.getmates(this.roles);for(var e=0,r=n.length;r>e;e++)t.moveTo(n[e][0].x,n[e][0].y),t.lineTo(n[e][1].x,n[e][1].y)},e.prototype.getmates=function(t){if(0!=t.length){var e=this.mates,n=this.startPoint=this.getStartPoint(t),r=[],o=[],i=0,a=0;t.sort(this.compare.bind(this));for(var s=n.type,c=t.length,u=1;c>u;u++)if(t[u].type==s)r.push(t[u]),i++;else{if(t[u].type==s||i==a){e.push([n,t[u]]),this.getmates(r);for(var h=u+1;c>h;h++)o.push(t[h]);this.getmates(o);break}r.push(t[u]),a++}}},e.prototype.compare=function(t,e){console.log(this.getPolarAngle);var n=this.getPolarAngle(this.startPoint,t),r=this.getPolarAngle(this.startPoint,e);return console.log(n),r>n?-1:n>r?1:t.x<e.x?-1:t.x>e.x?1:t.y<e.y?1:t.y>e.y?-1:0},e.prototype.getStartPoint=function(t){for(var e=t[0],n=1,r=t.length;r>n;n++)t[n].y<e.y?e=t[n]:t[n].y==e.y&&t[n].x<e.x&&(e=t[n]);return e},e.prototype.getPolarAngle=function(t,e){return Math.atan2(e.y-t.y,e.x-t.x)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,n=RES.getRes(t);return e.texture=n,e},e}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var ObjectDecorator=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.get=function(t){return e.currentObj=e.objs.filter(function(e,n,r){return e.obj==t?!0:void 0})[0],e.currentObj||(e.currentObj=new DragDisplayObject(t),e.objs.push(e.currentObj)),e},e.addDragAction=function(t,n,r){return void 0===n&&(n=null),void 0===r&&(r=!1),e.currentObj.obj.touchEnabled=!0,e.currentObj.range=n,e.currentObj.center=r,e.currentObj.obj.addEventListener(egret.TouchEvent.TOUCH_BEGIN,e.dragBeginHandler,this),e.stage=t,e},e.addRotateAction=function(t,n,r,o){return void 0===r&&(r=20),void 0===o&&(o=0),e.currentObj.handle=n,e.currentObj.distance=r,e.currentObj.angle=o,e.updateRotateHandlePosition(),n.touchEnabled=!0,e.currentObj.handle.addEventListener(egret.TouchEvent.TOUCH_BEGIN,e.rotateBeginHandler,this),e},e.upHandler=function(t){return e.currentObj.mouseup=t,e},e.moveHandler=function(t){return e.currentObj.mousemove=t,e},e.downHandler=function(t){return e.currentObj.mousedown=t,e},e.dragBeginHandler=function(t){var n=t.currentTarget;e.currentObj=e.objs.filter(function(t,e,r){return t.obj==n?!0:void 0})[0],e.isDraging=!0,e.currentObj.center?(e.offsetX=0,e.offsetY=0):(e.offsetX=t.stageX-n.x,e.offsetY=t.stageY-n.y),e.stage.hasEventListener(egret.TouchEvent.TOUCH_MOVE)||e.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,e.stageTouchMoveHandler,this),e.stage.hasEventListener(egret.TouchEvent.TOUCH_END)||e.stage.addEventListener(egret.TouchEvent.TOUCH_END,e.stageTouchEndHandler,this),e.currentObj.mousedown instanceof Function&&e.currentObj.mousedown()},e.rotateBeginHandler=function(t){var n=t.currentTarget;e.currentObj=e.objs.filter(function(t,e,r){return t.handle==n?!0:void 0})[0],e.isRotating=!0,e.stage.hasEventListener(egret.TouchEvent.TOUCH_MOVE)||e.stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,e.stageTouchMoveHandler,this),e.stage.hasEventListener(egret.TouchEvent.TOUCH_END)||e.stage.addEventListener(egret.TouchEvent.TOUCH_END,e.stageTouchEndHandler,this),e.currentObj.mousedown instanceof Function&&e.currentObj.mousedown()},e.stageTouchMoveHandler=function(t){if(null!=e.currentObj){if(e.isDraging){var n=t.stageX-e.offsetX,r=t.stageY-e.offsetY,o=e.currentObj.range;o instanceof egret.Rectangle&&(n=Math.min(Math.max(n,o.x),o.x+o.width),r=Math.min(Math.max(r,o.y),o.y+o.height)),e.currentObj.obj.x=n,e.currentObj.obj.y=r,e.updateRotateHandlePosition()}if(e.isRotating){e.currentObj.handle.x=t.stageX,e.currentObj.handle.y=t.stageY;var i=t.stageX-e.currentObj.obj.x,a=t.stageY-e.currentObj.obj.y,s=180*Math.atan2(a,i)/Math.PI;e.currentObj.obj.rotation=s-e.currentObj.angle}e.currentObj.mousemove instanceof Function&&e.currentObj.mousemove()}},e.stageTouchEndHandler=function(t){e.currentObj.mouseup instanceof Function&&e.currentObj.mouseup(),e.updateRotateHandlePosition(),e.isRotating=!1,e.isDraging=!1,e.currentObj=null,e.stage.removeEventListener(egret.TouchEvent.TOUCH_END,e.stageTouchEndHandler,this),e.stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,e.stageTouchMoveHandler,this)},e.updateRotateHandlePosition=function(){if(null!=e.currentObj.handle){var t=e.currentObj.distance,n=e.currentObj.angle+e.currentObj.obj.rotation,r=n*Math.PI/180,o=Math.cos(r)*t,i=Math.sin(r)*t;e.currentObj.handle.x=e.currentObj.obj.x+o,e.currentObj.handle.y=e.currentObj.obj.y+i}},e.objs=[],e.isRotating=!1,e.isDraging=!1,e}(egret.DisplayObject);__reflect(ObjectDecorator.prototype,"ObjectDecorator");var DebugPlatform=function(){function t(){}return t.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,{nickName:"username"}]})})},t.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2]})})},t}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);